apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: gitleaks-scan
  namespace: tekton-pipelines
  labels:
    app.kubernetes.io/part-of: colorforge
spec:
  description: |
    Scan de secrets no código fonte usando Gitleaks.
    Detecta credenciais, API keys, tokens e outros segredos hardcoded.
  params:
    - name: source-path
      type: string
      description: Caminho para o código fonte
      default: "."
    - name: config-path
      type: string
      description: Caminho para arquivo de configuração customizado
      default: ""
    - name: fail-on-leak
      type: string
      description: Falhar o pipeline se encontrar secrets
      default: "true"
    - name: redact
      type: string
      description: Ocultar valores sensíveis no relatório
      default: "true"
  workspaces:
    - name: source
      description: Workspace contendo o código fonte
  results:
    - name: leaks-found
      description: Número de leaks encontrados
    - name: scan-status
      description: Status do scan (passed/failed)
  steps:
    - name: scan-secrets
      image: zricethezav/gitleaks:v8.18.4
      workingDir: $(workspaces.source.path)/$(params.source-path)
      script: |
        #!/bin/sh
        set -e

        echo "=== Gitleaks Secret Scanner ==="
        echo "Source Path: $(params.source-path)"
        echo ""

        # Build command arguments
        ARGS="detect --source . --verbose"

        if [ "$(params.redact)" = "true" ]; then
          ARGS="${ARGS} --redact"
        fi

        if [ -n "$(params.config-path)" ] && [ -f "$(params.config-path)" ]; then
          ARGS="${ARGS} --config $(params.config-path)"
        fi

        # Run scan
        echo "=== Running Gitleaks ==="
        set +e
        gitleaks ${ARGS} --report-format json --report-path /tmp/gitleaks-report.json 2>&1
        SCAN_EXIT=$?
        set -e

        # Parse results
        LEAKS_COUNT=0
        if [ -f /tmp/gitleaks-report.json ]; then
          LEAKS_COUNT=$(cat /tmp/gitleaks-report.json | grep -c '"RuleID"' || echo "0")
        fi

        echo ""
        echo "=== Scan Summary ==="
        echo "Leaks Found: ${LEAKS_COUNT}"

        # Write results
        printf "%s" "${LEAKS_COUNT}" > "$(results.leaks-found.path)"

        if [ ${SCAN_EXIT} -ne 0 ] && [ ${LEAKS_COUNT} -gt 0 ]; then
          printf "failed" > "$(results.scan-status.path)"

          echo ""
          echo "WARNING: Secrets detected in codebase!"

          if [ "$(params.fail-on-leak)" = "true" ]; then
            echo "FAILED: Pipeline stopped due to secret leaks"
            exit 1
          else
            echo "WARNING: Continuing despite secret leaks (fail-on-leak=false)"
          fi
        else
          printf "passed" > "$(results.scan-status.path)"
          echo "No secrets detected!"
        fi

        echo ""
        echo "=== Gitleaks Scan Complete ==="
      computeResources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
