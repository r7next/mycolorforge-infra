apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: kaniko-build
  namespace: tekton-pipelines
  labels:
    app.kubernetes.io/part-of: mycolorforge
spec:
  description: |
    Build and push container images using Kaniko.
    Kaniko builds images inside a container without requiring Docker daemon.
    Optimized for Harbor registry with TLS support.
  params:
    - name: image
      type: string
      description: Full image name including registry (e.g., harbor.example.com/mycolorforge/api)
    - name: tag
      type: string
      description: Image tag
      default: latest
    - name: dockerfile
      type: string
      description: Path to Dockerfile relative to context
      default: Dockerfile
    - name: context
      type: string
      description: Build context path relative to workspace
      default: "."
    - name: build-args
      type: array
      description: Build arguments (KEY=VALUE format)
      default: []
    - name: cache
      type: string
      description: Enable layer caching
      default: "true"
    - name: cache-repo
      type: string
      description: Cache repository for layer caching
      default: ""
    - name: insecure-registry
      type: string
      description: Allow insecure registry (HTTP)
      default: "false"
    - name: skip-tls-verify
      type: string
      description: Skip TLS verification (for self-signed certs)
      default: "false"
    - name: verbosity
      type: string
      description: Log verbosity (panic, fatal, error, warn, info, debug, trace)
      default: "info"
  workspaces:
    - name: source
      description: Workspace containing the source code and Dockerfile
    - name: dockerconfig
      description: Docker config.json with registry credentials
      optional: true
  results:
    - name: image-digest
      description: Digest of the built image
    - name: image-url
      description: Full URL of the pushed image with digest
  steps:
    - name: build-and-push
      image: gcr.io/kaniko-project/executor:v1.21.0
      args:
        - --dockerfile=$(workspaces.source.path)/$(params.context)/$(params.dockerfile)
        - --context=$(workspaces.source.path)/$(params.context)
        - --destination=$(params.image):$(params.tag)
        - --digest-file=/tekton/results/image-digest
        - --verbosity=$(params.verbosity)
        - --snapshotMode=redo
        - --use-new-run
        - --cache=$(params.cache)
        - --cache-repo=$(params.cache-repo)
        - --skip-tls-verify=$(params.skip-tls-verify)
        - --insecure=$(params.insecure-registry)
        - $(params.build-args[*])
      env:
        - name: DOCKER_CONFIG
          value: $(workspaces.dockerconfig.path)
      securityContext:
        runAsUser: 0
      computeResources:
        requests:
          memory: "2Gi"
          cpu: "1000m"
        limits:
          memory: "6Gi"
          cpu: "4000m"
    - name: write-url
      image: busybox:1.36
      script: |
        #!/bin/sh
        DIGEST=$(cat /tekton/results/image-digest)
        echo "$(params.image)@${DIGEST}" > /tekton/results/image-url
        echo "Image built: $(params.image):$(params.tag)"
        echo "Digest: ${DIGEST}"
