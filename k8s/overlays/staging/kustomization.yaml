apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: colorforge

resources:
- ../../base

# Staging-specific labels
labels:
- pairs:
    app.kubernetes.io/instance: staging
    environment: staging

# Staging-specific annotations
commonAnnotations:
  argocd.argoproj.io/sync-options: Prune=true

# Image configuration - updated by Tekton pipeline
# Regras com digest são atualizadas automaticamente pelo pipeline
# IMPORTANTE: Usar apenas nomes canônicos para evitar duplicação
images:
- digest: sha256:20ccafe1e8d61e91c5a88a3b2c993fd5da997535d035d2fc6d8e14577ed0fd2f
  name: harbor.local/colorforge/frontend
  newName: harbor.local/colorforge/frontend
- digest: sha256:ed01751e63ff1e46c42b884fca7ae3ee3bd53b89465e47502d676a97a055e953
  name: mycolorforge-api
  newName: harbor.local/colorforge/backend
- digest: sha256:4160e8edeede2986ba22cec8b2787928407d35462d19799ecedde546fc2cf2d3
  name: mycolorforge-frontend
  newName: harbor.local/colorforge/frontend

# Staging replica counts (lower than prod)
replicas:
- count: 1
  name: api
- count: 1
  name: frontend

# ConfigMap generator for staging config
configMapGenerator:
- behavior: create
  literals:
  - ENV=staging
  - LOG_LEVEL=debug
  - CORS_ORIGINS=https://colorforge.local,https://api.colorforge.local
  name: colorforge-config

# Patches for staging


  # Update ingress for local environment
    # NEXT_PUBLIC_* variables are embedded at build time via Tekton pipeline
    # No runtime env vars needed for Next.js
patches:
- patch: |
    - op: add
      path: /spec/template/spec/imagePullSecrets
      value:
        - name: harbor-pull-secret
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "128Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: "100m"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "256Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: "300m"
    - op: replace
      path: /spec/template/spec/containers/0/env/2
      value:
        name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: postgres-credentials
            key: DATABASE_URL
    - op: replace
      path: /spec/template/spec/containers/0/env/5
      value:
        name: CORS_ORIGINS
        value: "https://colorforge.local,https://api.colorforge.local,https://mycolorforge.com,https://www.mycolorforge.com"
    - op: replace
      path: /spec/template/spec/containers/0/env/6
      value:
        name: OTEL_ENABLED
        value: "true"
    - op: replace
      path: /spec/template/spec/containers/0/env/7
      value:
        name: OTEL_EXPORTER_OTLP_ENDPOINT
        value: "otel-collector.observability.svc.cluster.local:4317"
  target:
    kind: Deployment
    name: api
- patch: |
    - op: add
      path: /spec/template/spec/imagePullSecrets
      value:
        - name: harbor-pull-secret
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: "128Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: "100m"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: "256Mi"
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: "300m"
    # NEXT_PUBLIC_* variables are embedded at build time via Tekton pipeline
    # No runtime env vars needed for Next.js
  target:
    kind: Deployment
    name: frontend
- patch: |
    - op: replace
      path: /metadata/annotations
      value:
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        cert-manager.io/cluster-issuer: local-ca-issuer
    - op: replace
      path: /spec/ingressClassName
      value: nginx
    - op: replace
      path: /spec/tls
      value:
        - hosts:
            - colorforge.local
            - api.colorforge.local
          secretName: colorforge-tls
    - op: replace
      path: /spec/rules
      value:
        - host: colorforge.local
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: frontend-service
                    port:
                      number: 3000
        - host: api.colorforge.local
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: api-service
                    port:
                      number: 8080
  target:
    kind: Ingress
    name: mycolorforge-ingress
